<app-modal-primeng
  [title]="'RECUPERAR CONTRASEÑA'"
  [showModal]="showModal"
  [width]="'560px'"
  (accionBtnItem)="accionBtn($event)"
>
  @switch (paso) {
    @case (1) {
      <form
        class="flex justify-content-center align-items-center pt-6 px-6"
        [formGroup]="formCredencial"
      >
        <div class="grid">
          <div class="col-12 text-center">
            <h2 class="font-bold">¿Has olvidado tu contraseña?</h2>
          </div>
          <div class="col-12 text-justify">
            Ingresa tu usuario y enviaremos un código de verificación a tu correo electrónico para
            restablecer la contraseña.
          </div>

          <div class="col-12">
            <div class="flex flex-column mt-4 w-full">
              <label class="font-bold" for="cCredUsuario">Usuario</label>
              <input
                class="mt-1"
                type="text"
                pInputText
                placeholder="Ingrese su usuario"
                name="cCredUsuario"
                formControlName="cCredUsuario"
              />
            </div>
          </div>
        </div>
      </form>
    }
    @case (2) {
      <form
        class="flex justify-content-center align-items-center pt-6 px-6"
        [formGroup]="formCredencial"
      >
        <div class="grid">
          <div class="col-12 text-center">
            <h2 class="font-bold">Introduce el código de 6 dígitos</h2>
          </div>
          <div class="col-12 text-justify">
            Consulta el código de verificación en {{ correoMasked }} y escríbelo en el campo de
            abajo para continuar con el restablecimiento de la contraseña.
            @if (reenviandoCodigo) {
              <a href="" (click)="$event.preventDefault()"
                >Reenviando código <i class="pi pi-spin pi-spinner"></i
              ></a>
            } @else {
              <a href="#" (click)="enviarCodigoRecuperacion(true); $event.preventDefault()"
                >Reenviar código</a
              >
            }
          </div>
          <p-inputOtp
            formControlName="cCodigoRecuperacion"
            class="col-12 mt-2"
            style="gap: 2"
            [length]="6"
            ><ng-template pTemplate="input" let-token let-events="events">
              <input
                type="text"
                class="w-full p-inputtext-sm ml-1 codigo"
                maxlength="1"
                pInputText
                (input)="events.input($event)"
                (keydown)="events.keydown($event)"
              /> </ng-template
          ></p-inputOtp>
        </div>
      </form>
    }
    @case (3) {
      <form
        class="flex justify-content-center align-items-center pt-6 px-6"
        [formGroup]="formCredencial"
      >
        <div class="grid">
          <div class="col-12 text-center">
            <h2 class="font-bold">Ingresa una nueva contraseña</h2>
          </div>

          <div class="col-12">
            <div class="flex flex-column mt-4 w-full">
              <label for="contrasenaNueva" class="font-bold">Ingrese la contraseña nueva</label>
              <p-password
                formControlName="contrasenaNueva"
                [toggleMask]="true"
                placeholder="Contraseña nueva"
                styleClass="w-full"
              >
                <ng-template pTemplate="footer">
                  <p-divider />
                  <ul class="pl-2 ml-2 mt-0" style="line-height: 1.5">
                    <li>Al menos una letra minúscula y mayúscula</li>
                    <li>Al menos un número</li>
                    <li>Mínimo 8 caracteres</li>
                  </ul>
                </ng-template>
              </p-password>
              <small
                class="p-error"
                *ngIf="
                  this.formCredencial.get('contrasenaNueva')?.errors?.['required'] &&
                  this.formCredencial.get('contrasenaNueva')?.touched
                "
              >
                La nueva contraseña es requerida
              </small>
              <small
                class="p-error"
                *ngIf="
                  this.formCredencial.get('contrasenaNueva')?.errors?.['minlength'] &&
                  this.formCredencial.get('contrasenaNueva')?.touched
                "
              >
                La contraseña debe tener al menos 8 caracteres
              </small>
            </div>
          </div>

          <div class="col-12">
            <div class="flex flex-column mt-4 mb-6 w-full">
              <label for="contrasenaNueva" class="font-bold">Confirma la contraseña nueva</label>
              <p-password
                formControlName="confirmarContrasena"
                [feedback]="false"
                [toggleMask]="true"
                placeholder="Confirma la contraseña nueva"
                styleClass="w-full"
              >
              </p-password>
              <small
                class="p-error"
                *ngIf="
                  this.formCredencial.get('confirmarContrasena')?.errors?.['required'] &&
                  this.formCredencial.get('confirmarContrasena')?.touched
                "
              >
                Confirma la nueva contraseña
              </small>
              <small
                class="p-error"
                *ngIf="
                  this.formCredencial.get('confirmarContrasena')?.errors?.['noCoinciden'] &&
                  this.formCredencial.get('confirmarContrasena')?.touched
                "
              >
                Las contraseñas no coinciden
              </small>
            </div>
          </div>
        </div>
      </form>
    }
    @case (4) {
      <form class="flex justify-content-center align-items-center pt-6 px-6">
        <div class="grid">
          <div class="col-12 text-center">
            <img src="assets/images/icons/good2.gif" alt="logo" width="50%" />
          </div>
          <div class="col-12 text-center">
            <h2 class="font-bold">La contraseña ha sido restablecida exitosamente</h2>
          </div>
          <div class="col-12 text-justify">
            Ahora puedes iniciar sesión con su nueva contraseña. Si tienes algún problema,
            comunícate con soporte a
            <a href="mailto:soporte@educavirtual.edu.pe">soporte&#64;educavirtual.edu.pe</a>.
          </div>
        </div>
      </form>
    }
  }
  <div footer class="px-6">
    <div class="mb-3">
      @if (paso === 1) {
        <p-button
          label="Enviar"
          styleClass="w-full"
          (onClick)="enviarCodigoRecuperacion(false)"
          severity="success"
          [disabled]="
            this.formCredencial.value.cCredUsuario === '' ||
            this.formCredencial.value.cCredUsuario === null
          "
          [loading]="isLoading"
        />
      }

      @if (paso === 2) {
        <p-button
          label="Validar"
          styleClass="w-full"
          [loading]="isLoading"
          (onClick)="validarCodigoRecuperacion()"
          [disabled]="
            this.formCredencial.value.cCodigoRecuperacion === '' ||
            this.formCredencial.value.cCodigoRecuperacion === null
          "
        />
      }

      @if (paso === 3) {
        <p-button
          label="Cambiar contraseña"
          styleClass="w-full"
          [loading]="isLoading"
          (onClick)="cambiarPassword()"
          [disabled]="this.formCredencial.invalid"
        />
      }
      @if (paso === 4) {
        <p-button
          label="Regresar a inicio de sesión"
          styleClass="w-full"
          (onClick)="showModal = false"
        />
      }
    </div>
    @if (paso < 4) {
      <div class="mb-3">
        <p-button
          label="Cancelar"
          styleClass="w-full"
          (onClick)="showModal = false"
          severity="secondary"
        />
        @if (paso === 2) {
          <p class="text-justify mt-2">
            Si no ves el email en tu buzón, consulta la carpeta de correo no deseado. Si no tienes
            acceso a ese correo, comunicate a
            <a href="mailto:soporte@educavirtual.edu.pe">soporte&#64;educavirtual.edu.pe</a>
          </p>
        }
      </div>
    }
  </div>
</app-modal-primeng>

<p-toast />
