<section>
  <div class="grid">
    <div class="col card m-1">
      <app-toolbar-primeng title="Listado de Capacitación Activas"></app-toolbar-primeng>
      <app-table-primeng
        [columnas]="columnasTabla"
        [data]="cursos"
        [showCaption]="false"
        (accionBtnItem)="accionBnt($event)"
        [actions]="accionesTabla"
      >
      </app-table-primeng>
    </div>
    <div class="col-7 card">
      <app-toolbar-primeng
        [title]="
          modoFormulario === 'editar' ? 'Actualizar Capacitación' : 'Aperturar Nueva Capacitación'
        "
      ></app-toolbar-primeng>
      <form [formGroup]="formNuevaCapacitacion" class="flex flex-column gap-3 w-full">
        <section>
          <div class="col">
            <p-inputGroup>
              <p-inputGroupAddon>Tipo de Capacitación:</p-inputGroupAddon>
              <p-dropdown
                [options]="tipoCapacitacion"
                styleClass="w-full"
                formControlName="iTipoCapId"
                placeholder="Seleccione el tipo"
                optionValue="iTipoCapId"
                optionLabel="cTipoCapNombre"
                (onChange)="capacitacionExterna($event.value)"
              ></p-dropdown>
            </p-inputGroup>
          </div>
          <div class="col">
            <p-inputGroup>
              <p-inputGroupAddon>Título: </p-inputGroupAddon>

              <input
                type="text"
                pInputText
                placeholder="Ingresar nombre...."
                formControlName="cCapTitulo"
                [ngClass]="{
                  'p-invalid':
                    formNuevaCapacitacion.get('titulo')?.invalid &&
                    formNuevaCapacitacion.get('titulo')?.touched,
                }"
              />
            </p-inputGroup>
            <!-- Mensaje de error -->
            <small
              class="p-error"
              *ngIf="
                formNuevaCapacitacion.get('titulo')?.invalid &&
                formNuevaCapacitacion.get('titulo')?.touched
              "
            >
              El título es obligatorio.
            </small>
          </div>

          <!-- select p-dropdown -->
          <div class="col">
            <div class="grid">
              <div class="col-6">
                <p-inputGroup>
                  <p-inputGroupAddon>Nivel Pedagógico:</p-inputGroupAddon>
                  <p-dropdown
                    [options]="nivelPedagogico"
                    styleClass="w-full"
                    formControlName="iNivelPedId"
                    optionValue="iNivelPedId"
                    optionLabel="cNivelPedNombre"
                    placeholder="Seleccione Nivel"
                  ></p-dropdown>
                  <!-- id="modalidad" [options]="modalidades" -->
                </p-inputGroup>
              </div>
              <div class="col-6">
                <p-inputGroup>
                  <p-inputGroupAddon>Dirigido para:</p-inputGroupAddon>
                  <p-dropdown
                    [options]="publicoObjetivo"
                    styleClass="w-full"
                    formControlName="iTipoPubId"
                    placeholder="Seleccione Publico"
                    optionValue="iTipoPubId"
                    optionLabel="cTipoPubNombre"
                  ></p-dropdown>
                  <!-- id="modalidad" [options]="modalidades" -->
                </p-inputGroup>
              </div>
            </div>
          </div>

          <!-- Descripción adicional -->
          <div class="col">
            <div class="formgrid grid">
              <div class="field col">
                <label for="descripcion" class="mt-1"
                  >Descripción <span class="text-red-500 text-xs">(*) Obligatorio</span></label
                >
                <p-editor
                  formControlName="cCapDescripcion"
                  [style]="{ height: 'auto' }"
                  placeholder="Escribir una descripción...."
                />
              </div>
            </div>
          </div>
          <!-- agregar horas -->
          <div class="col">
            <div class="grid">
              <div class="col-12 md:col-3">
                <p-inputGroup>
                  <p-inputGroupAddon>Horas: </p-inputGroupAddon>
                  <input
                    type="number"
                    pInputText
                    min="1"
                    placeholder="0"
                    formControlName="iTotalHrs"
                    [ngClass]="{
                      'p-invalid':
                        formNuevaCapacitacion.get('hora')?.invalid &&
                        formNuevaCapacitacion.get('hora')?.touched,
                    }"
                  />
                </p-inputGroup>
                <!-- Mensaje de error -->
                <small
                  class="p-error"
                  *ngIf="
                    formNuevaCapacitacion.get('hora')?.invalid &&
                    formNuevaCapacitacion.get('hora')?.touched
                  "
                >
                  El título es obligatorio.
                </small>
              </div>
              <div class="col-12 md:col-5">
                <p-inputGroup>
                  <p-inputGroupAddon>Fecha Inicio:</p-inputGroupAddon>
                  <p-calendar
                    id="fechaFin"
                    formControlName="dFechaInicio"
                    styleClass="w-full"
                    dateFormat="dd/mm/yy"
                    [iconDisplay]="'input'"
                    [showIcon]="true"
                    inputId="icondisplay"
                  ></p-calendar>
                </p-inputGroup>
              </div>
              <div class="col-12 md:col-4">
                <p-inputGroup>
                  <p-inputGroupAddon>Fecha Fin:</p-inputGroupAddon>
                  <p-calendar
                    id="fechaFin"
                    formControlName="dFechaFin"
                    styleClass="w-full"
                    dateFormat="dd/mm/yy"
                    [iconDisplay]="'input'"
                    [showIcon]="true"
                    inputId="icondisplay"
                  ></p-calendar>
                </p-inputGroup>
              </div>
            </div>
          </div>
          <!-- instructor y pago -->
          @if (codCapacitacion === CAP_EXT) {
            <div class="col">
              <p-inputGroup>
                <p-inputGroupAddon>Link: </p-inputGroupAddon>

                <input
                  type="url"
                  pInputText
                  placeholder="Ingresar url...."
                  formControlName="cLink"
                  pattern="https?://.+"
                  [ngClass]="{
                    'p-invalid':
                      formNuevaCapacitacion.get('cLink')?.invalid &&
                      formNuevaCapacitacion.get('cLink')?.touched,
                  }"
                />
              </p-inputGroup>
              <!-- Mensaje de error -->
              <small
                *ngIf="
                  formNuevaCapacitacion.get('cLink')?.errors?.['pattern'] &&
                  formNuevaCapacitacion.get('cLink')?.touched
                "
                class="p-error"
              >
                Ingrese una URL válida.
              </small>
            </div>
          } @else {
            <div class="col">
              <div class="grid">
                <div class="col-7">
                  <p-inputGroup>
                    <p-inputGroupAddon>Instructor: </p-inputGroupAddon>
                    <p-dropdown
                      [options]="instructores"
                      formControlName="iInstId"
                      optionLabel="nombreLargo"
                      optionValue="iInstId"
                      styleClass="w-full"
                      [filter]="true"
                      filterBy="nombreLargo"
                      [showClear]="true"
                      placeholder="Seleccionar instructor"
                    >
                    </p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col">
                  <div class="flex align-items-center justify-content-between">
                    <label for="" class="pr-3">¿Tiene Costo?</label>
                    <p-inputSwitch formControlName="iCosto" class="pr-3" />
                    <!-- Input visible solo si iPago está activado -->
                    <input
                      *ngIf="formNuevaCapacitacion.get('iCosto')?.value"
                      type="text"
                      formControlName="nCosto"
                      placeholder="S/.0.0"
                      class="p-inputtext p-component w-10rem"
                    />
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- agregar imagenes para el curso -->
          <div class="col">
            <div class="border-round w-full btnimag">
              <div class="flex justify-content-between flex-wrap">
                <div class="flex align-items-center justify-content-center m-2">
                  Añadir imagen de portada del curso
                </div>
                <div class="flex align-items-center justify-content-center m-2">
                  <p-inputSwitch formControlName="iImageAleatorio" class="pr-3" />
                </div>
              </div>
            </div>
            <div
              class="card w-full mt-2 justify-content-center"
              *ngIf="formNuevaCapacitacion.get('iImageAleatorio')?.value"
            >
              <div class="container">
                <!-- <h2>Selecciona una imagen</h2> -->
                <!-- (ngSubmit)="onSubmit()" -->
                <p-carousel
                  #carousel
                  [value]="portada"
                  [numVisible]="3"
                  [numScroll]="1"
                  [circular]="true"
                  [responsiveOptions]="responsiveOptions"
                >
                  <ng-template let-image let-index="index" pTemplate="item">
                    <div
                      [tabindex]="index"
                      class="image-item"
                      [class.selected]="isSelected(image)"
                      (click)="selectImage(image)"
                      (keyup)="selectImage(null)"
                    >
                      <div class="image-container">
                        <img
                          [src]="backend + image.url"
                          [alt]="image.title"
                          class="carousel-image"
                        />
                        <div class="image-title">
                          {{ image.title }}
                        </div>
                        <div *ngIf="isSelected(image)" class="selected-indicator">
                          <i class="pi pi-check-circle"></i>
                        </div>
                      </div>
                    </div>
                  </ng-template>
                </p-carousel>

                <div class="form-info" *ngIf="selectedImageId">
                  <p>
                    Imagen seleccionada: Nro
                    {{ selectedImageId }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </form>
      <!-- Agregar los bottones -->
      <div class="flex justify-content-between flex-wrap gap-2">
        <p-button
          icon="pi pi-hammer"
          label="Limpiar"
          severity="danger"
          class="m-2"
          (click)="limpiarFormulario()"
        ></p-button>

        <p-button
          *ngIf="codCapacitacion !== CAP_EXT"
          icon="pi pi-clock"
          label="Configurar horarios"
          severity="success"
          class="m-2"
          [disabled]="
            !formNuevaCapacitacion.value.dFechaInicio ||
            !formNuevaCapacitacion.value.dFechaFin ||
            !formNuevaCapacitacion.value.iTotalHrs
          "
          (click)="showModalHorarios = true"
        ></p-button>

        <!-- <p-button
          icon="pi pi-eye"
          label="Visualizar"
          severity="contrast"
          class="m-2"
          (click)="showVistaPreviaCurso()"
        ></p-button> -->

        <p-button
          icon="pi pi-check-circle"
          [label]="modoFormulario === 'editar' ? 'Actualizar' : 'Guardar'"
          severity="success"
          class="m-2"
          (click)="enviarFormulario()"
          [loading]="loadingGuardar"
          [disabled]="!isValidForm() || loadingGuardar"
        ></p-button>
      </div>
    </div>
  </div>
</section>

<!-- modal de agregar horario al curso -->
<app-asignar-horario-capacitacion
  *ngIf="showModalHorarios"
  [showModal]="showModalHorarios"
  [data]="formNuevaCapacitacion.value"
  (accionCloseForm)="showModalHorarios = false"
  (accionEnviarHorario)="guardarHorarioCapacitacion($event)"
></app-asignar-horario-capacitacion>

<!-- modal de vista previa del curso creado -->
<p-dialog
  header="Visualización del curso"
  [(visible)]="showVistaPrevia"
  [modal]="true"
  [style]="{ width: '60rem' }"
>
  <div class="card flex justify-content-center">
    <article
      class="card p-0 border-1 flex flex-column surface-border overflow-hidden w-23rem h-33rem my-6 post-module"
    >
      <div class="curso__image-container img-transition">
        <img [src]="" alt="{{ '' }}" />
      </div>
      <!-- <div class="h-12rem"></div> -->
      <div class="mb-auto">
        <div class="text-xl">
          <small class="text-primary font-bold"></small>
          <br />
          <div class="grid row-gap-2">
            <div class="col-12 title text-center font-bold">
              {{ datosprevios?.cCapTitulo }}
            </div>
            <div class="mx-4 col-12 grid">
              <div class="col-12 grid column-gap-1 align-items-center">
                <i class="pi pi-cog"></i>
                <span>Modalidad: {{ 'Virtual' }}</span>
              </div>
              <div class="col-12 grid column-gap-1 align-items-center">
                <i class="pi pi-clock"></i>
                <span>Horario: {{ '08:00 am - 09:45 am' }}</span>
              </div>
            </div>
          </div>
          <div class="p-3 col-12 grid justify-content-end">
            <div>
              <p-button
                sty
                label="Ingresar"
                icon="pi pi-arrow-circle-right"
                severity="success"
                iconPos="right"
              />
            </div>
          </div>
        </div>
      </div>
    </article>
  </div>

  <div class="flex justify-content-end">
    <p-button icon="pi pi-check" label="Aceptar" class="m-2" (click)="showVistaPrevia = false" />
  </div>
</p-dialog>

<p-toast />
