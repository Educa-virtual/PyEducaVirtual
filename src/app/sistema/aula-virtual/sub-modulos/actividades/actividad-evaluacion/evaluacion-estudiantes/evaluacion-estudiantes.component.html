<app-toolbar-primeng
    [title]="'Evaluación Formativa: ' + (evaluacion?.cEvaluacionTitulo || '')"
>
    <div class="flex flex-column">
        <p class="flex flex-column text-white text-center text-2xl">
            <i class="pi pi-clock mr-2 text-3xl"></i>
            {{ tiempoEnMilisegundos ?? '00:00:00' }}
        </p>
        <!-- Contador de preguntas -->
        <p class="font-bold">
            Pregunta {{ iPreguntaId }} de {{ evaluacion?.preguntas?.length }}
        </p>
    </div>
</app-toolbar-primeng>
<div class="card">
    <div *ngIf="iPreguntaId === 0">
        <!-- Contenido inicial de la evaluación -->
        <div class="grid">
            <div class="col-12 md:col-5">
                <span class="font-bold text-xl flex gap-2 mt-4">
                    <app-icon
                        name="matCalendarMonth"
                        class="text-primary"
                        size="sm"
                    ></app-icon>
                    Inicio de Evaluación Formativa
                </span>
                <p>
                    {{
                        evaluacion?.dtEvaluacionInicio
                            | date: "EEEE, d 'de' MMMM 'de' yyyy"
                    }}
                    {{ evaluacion?.dtEvaluacionInicio | date: 'h:mm a' }}
                </p>
                <span class="font-bold text-xl flex gap-2 mt-8">
                    <app-icon
                        name="matCalendarMonth"
                        class="text-primary"
                        size="sm"
                    ></app-icon>
                    Cierre de Evaluación Formativa
                </span>
                <p>
                    {{
                        evaluacion?.dtEvaluacionFin
                            | date: "EEEE, d 'de' MMMM 'de' yyyy"
                    }}
                    {{ evaluacion?.dtEvaluacionFin | date: 'h:mm a' }}
                </p>
            </div>
            <div class="col-12 md:col-3 mt-5">
                <div class="grid">
                    <div class="col-6">
                        <img
                            src="assets/images/icons/tiempo.gif"
                            alt="Tiempo"
                            width="100%"
                        />
                    </div>
                    <div class="col-6 mt-4">
                        <span>Duración:</span>
                        <h1>
                            {{ evaluacion?.iTiempo }} &nbsp;<span
                                class="text-none"
                                style="font-size: small"
                                >minutos</span
                            >
                        </h1>
                    </div>
                </div>
                <p class="text-center mt-0">
                    Total preguntas: {{ evaluacion?.preguntas?.length }}
                </p>
            </div>

            <div
                *ngIf="evaluacion?.bEstadoEvaluacion === '1'"
                class="col-12 md:col-3 mt-2"
                align="center"
            >
                <p class="font-bold">Evaluación empieza en:</p>

                <!-- <div class="col-12 md:col-3 mt-2" align="center">
                    <p class="font-bold">Evaluación empieza en:</p>
                    <h1 class="text-primary">{{ getFormattedTime() }}</h1>
                </div> -->
                <!-- Temporizador deshabilitado -->
            </div>
            <div
                *ngIf="evaluacion?.bEstadoEvaluacion === '0'"
                class="col-12 md:col-3 mt-2"
                align="center"
            >
                <h2 class="font-bold text-red-500">Evaluación finalizada</h2>
                <!-- Temporizador deshabilitado -->
            </div>
            <div class="col-12">
                <p class="font-bold">Instrucciones</p>
                <div class="container p-2">
                    <div [innerHTML]="evaluacion?.cEvaluacionDescripcion"></div>
                </div>
            </div>

            <div
                class="col-12"
                align="right"
                [hidden]="evaluacion?.bEstadoEvaluacion === '0'"
            >
                <p-button
                    label="Iniciar Evaluación"
                    severity="primary"
                    (onClick)="iniciarEvaluacion()"
                ></p-button>
            </div>
        </div>
    </div>

    <div class="grid">
        <div class="col-12">
            <article class="card">
                <h2>Recursos de Ayuda</h2>
                @if (evaluacion?.cEvaluacionArchivoAdjunto.length === 0) {
                    <app-empty-section
                        class="w-full"
                        [message]="'Sin recursos asignados'"
                    ></app-empty-section>
                } @else {
                    <app-recursos-lista
                        [files]="evaluacion?.cEvaluacionArchivoAdjunto ?? []"
                    ></app-recursos-lista>
                }
            </article>
        </div>
    </div>
    <div class="container">
        <div class="col-12">
            <p-inputGroup>
                <p-inputGroupAddon> Retroalimentación: </p-inputGroupAddon>
                <textarea
                    pInputText
                    [(ngModel)]="cTareaEstudianteComentarioDocente"
                ></textarea>
            </p-inputGroup>
        </div>
    </div>
    <div
        *ngIf="iPreguntaId > 0 && evaluacion?.preguntas?.length >= iPreguntaId"
    >
        <!-- Contenido de las preguntas -->

        <div class="grid">
            @if (itemPreguntas['iTipoPregId']) {
                <div class="col-12">
                    <p class="font-bold">Pregunta {{ iPreguntaId }}</p>
                </div>
                <div class="col-12">
                    <div [innerHTML]="itemPreguntas['cPregunta']"></div>
                </div>
                @switch (itemPreguntas['iTipoPregId']) {
                    @case (1) {
                        <!--Unica Tropical-->
                        <div
                            class="col-12 px-2"
                            *ngIf="itemPreguntas['alternativas']?.length > 0"
                        >
                            <div
                                *ngFor="
                                    let alternativa of itemPreguntas[
                                        'alternativas'
                                    ];
                                    let i = index
                                "
                            >
                                <div class="flex mt-1">
                                    <p-radioButton
                                        [inputId]="'alternativa'"
                                        name="alternativa"
                                        [value]="alternativa['cBancoAltLetra']"
                                        [(ngModel)]="
                                            itemPreguntas['cRptaRadio']
                                        "
                                        (onClick)="
                                            enviarRpta('unica', itemPreguntas)
                                        "
                                    />
                                    &nbsp;&nbsp;
                                    <div
                                        [innerHTML]="
                                            alternativa[
                                                'cAlternativaDescripcion'
                                            ]
                                        "
                                    ></div>
                                </div>
                            </div>
                        </div>
                    }
                    @case (2) {
                        <!--Opcion Múltiple-->
                        <div
                            class="col-12 px-2"
                            *ngIf="itemPreguntas['alternativas']?.length > 0"
                        >
                            <div
                                *ngFor="
                                    let alternativa of itemPreguntas[
                                        'alternativas'
                                    ]
                                "
                            >
                                <div class="flex mt-1">
                                    <p-checkbox
                                        [(ngModel)]="alternativa.cRptaCheck"
                                        [value]="alternativa['cBancoAltLetra']"
                                        (onChange)="
                                            enviarRpta(
                                                'multiple',
                                                itemPreguntas
                                            )
                                        "
                                    />
                                    &nbsp;&nbsp;
                                    <div
                                        [innerHTML]="
                                            alternativa[
                                                'cAlternativaDescripcion'
                                            ]
                                        "
                                    ></div>
                                </div>
                            </div>
                        </div>
                    }
                    @case (3) {
                        <!--Opcion Libre-->
                        <div class="col-12 px-2">
                            <textarea
                                class="w-full"
                                rows="4"
                                placeholder="Ingrese su respuesta"
                                pInputText
                                [(ngModel)]="itemPreguntas['cRptaTexto']"
                                (blur)="enviarRpta('libre', itemPreguntas)"
                            ></textarea>
                        </div>
                    }
                }
            } @else {
                <div class="col-12">
                    <p class="font-bold">Enunciado</p>
                </div>
                <div class="col-6">
                    <ngx-doc-viewer
                        [url]="
                            environment +
                            '/' +
                            itemPreguntas['cEncabPregContenido']
                        "
                        viewer="pdf"
                        style="width: 100%; height: 50vh"
                    ></ngx-doc-viewer>
                </div>
                <div class="col-6 grid">
                    @for (item of itemPreguntas['preguntas']; track item.id) {
                        <div class="col-12">
                            <div [innerHTML]="item['cPregunta']"></div>
                        </div>

                        @switch (item['iTipoPregId']) {
                            @case (1) {
                                <!--Unica Tropical-->
                                <div
                                    class="col-12 px-2"
                                    *ngIf="item['alternativas']?.length > 0"
                                >
                                    <div
                                        *ngFor="
                                            let alternativa of item[
                                                'alternativas'
                                            ];
                                            let i = index
                                        "
                                    >
                                        <div class="flex mt-1">
                                            <p-radioButton
                                                [inputId]="'alternativa'"
                                                name="alternativa"
                                                [value]="
                                                    alternativa[
                                                        'cBancoAltLetra'
                                                    ]
                                                "
                                                [(ngModel)]="item['cRptaRadio']"
                                                (onClick)="
                                                    enviarRpta('unica', item)
                                                "
                                            />
                                            &nbsp;&nbsp;
                                            <div
                                                [innerHTML]="
                                                    alternativa[
                                                        'cAlternativaDescripcion'
                                                    ]
                                                "
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            }
                            @case (2) {
                                <!--Opcion Múltiple-->
                                <div
                                    class="col-12 px-2"
                                    *ngIf="item['alternativas']?.length > 0"
                                >
                                    <div
                                        *ngFor="
                                            let alternativa of item[
                                                'alternativas'
                                            ]
                                        "
                                    >
                                        <div class="flex mt-1">
                                            <p-checkbox
                                                [(ngModel)]="
                                                    alternativa.cRptaCheck
                                                "
                                                [value]="
                                                    alternativa[
                                                        'cBancoAltLetra'
                                                    ]
                                                "
                                                (onChange)="
                                                    enviarRpta('multiple', item)
                                                "
                                            />
                                            &nbsp;&nbsp;
                                            <div
                                                [innerHTML]="
                                                    alternativa[
                                                        'cAlternativaDescripcion'
                                                    ]
                                                "
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            }
                            @case (3) {
                                <!--Opcion Libre-->
                                <div class="col-12 px-2">
                                    <textarea
                                        class="w-full"
                                        rows="4"
                                        placeholder="Ingrese su respuesta"
                                        pInputText
                                        [(ngModel)]="item['cRptaTexto']"
                                        (blur)="enviarRpta('libre', item)"
                                    ></textarea>
                                </div>
                            }
                        }
                    }
                </div>
            }
            <div class="col-6 mt-2" align="left">
                <p-button
                    label="Atrás"
                    severity="secondary"
                    *ngIf="iPreguntaId > 1"
                    (onClick)="regresarPregunta()"
                ></p-button>
            </div>
            <div class="col-6 mt-2" align="right">
                <p-button
                    label="Siguiente"
                    severity="primary"
                    *ngIf="evaluacion?.preguntas?.length > iPreguntaId"
                    (onClick)="siguienteEvaluacion()"
                ></p-button>
                <p-button
                    label="Finalizar Evaluación"
                    severity="primary"
                    *ngIf="evaluacion?.preguntas?.length === iPreguntaId"
                    (onClick)="finalizarEvaluacion()"
                ></p-button>
            </div>
        </div>
    </div>
</div>
<p-toast />

<p-confirmDialog>
    <ng-template pTemplate="message" let-message>
        <div
            class="flex flex-column align-items-center w-full gap-3 border-bottom-1 surface-border"
        >
            <i class="pi pi-exclamation-circle text-6xl text-primary-500"></i>
            <p>{{ message.message }}</p>
        </div>
    </ng-template>
</p-confirmDialog>
<div class="col-12 floating-header"></div>
