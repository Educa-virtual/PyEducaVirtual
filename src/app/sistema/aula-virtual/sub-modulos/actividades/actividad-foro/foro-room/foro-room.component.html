<section class="flex flex-column gap-4">
    <p-tabView styleClass="actividad-tabs">
        <!-- Mostrar informacion general del foro -->
        <p-tabPanel>
            <ng-template pTemplate="header">
                <div class="flex align-items-center flex-column gap-2">
                    <app-icon name="matListAlt"></app-icon>
                    <span class="font-bold white-space-nowrap m-0">
                        Instrucciones
                    </span>
                </div>
            </ng-template>
            <div class="flex flex-column gap-4">
                <div class="card grid">
                    <div [class]="iPerfilId !== 8 ? 'col-12' : 'col-8'">
                        <article class="card">
                            <h2>Foro: {{ foro?.cForoTitulo }}</h2>
                            <hr />

                            <div class="grid mb-4">
                                <div
                                    class="col-12 md:col-6 flex flex-column gap-2 align-items-start"
                                >
                                    <div
                                        class="col-12 md:col-6 gap-2 flex flex-column"
                                    >
                                        <span class="font-bold text-xl"
                                            >Catergoria:</span
                                        >
                                        {{ foro?.cForoCatDescripcion }}
                                    </div>
                                </div>
                            </div>

                            <div class="grid mb-4">
                                <div
                                    class="col-12 md:col-6 flex flex-column gap-2"
                                >
                                    <span class="font-bold text-xl flex gap-2">
                                        <app-icon
                                            name="matCalendarMonth"
                                            class="text-primary"
                                            size="sm"
                                        ></app-icon>
                                        Inicio de Foro:
                                    </span>
                                    <!-- {{ foro.dtForoInicio }} -->
                                    <p class="flex gap-2 flex-wrap">
                                        {{
                                            foro?.dtForoInicio
                                                | date
                                                    : "EEEE, d 'de' MMMM 'de' yyyy"
                                        }}

                                        <span class="flex gap-2">
                                            <app-icon
                                                name="matAccessTime"
                                                class="text-primary"
                                                size="sm"
                                            ></app-icon>
                                            <span class="font-bold"
                                                >Hora Limite:</span
                                            >
                                            {{
                                                foro?.dtForoInicio
                                                    | date: 'h:mm a'
                                            }}
                                        </span>
                                    </p>
                                </div>
                                <div
                                    class="col-12 md:col-6 flex flex-column gap-2"
                                >
                                    <span class="font-bold text-xl flex gap-2">
                                        <app-icon
                                            name="matCalendarMonth"
                                            class="text-primary"
                                            size="sm"
                                        ></app-icon>
                                        Cierre de Foro
                                    </span>
                                    <!-- {{ foro.dtForoFin }} -->
                                    <p class="flex gap-2 flex-wrap">
                                        {{
                                            foro?.dtForoFin
                                                | date
                                                    : "EEEE, d 'de' MMMM 'de' yyyy"
                                        }}

                                        <span class="flex gap-2">
                                            <app-icon
                                                name="matAccessTime"
                                                class="text-primary"
                                                size="sm"
                                            ></app-icon>
                                            <span class="font-bold"
                                                >Hora Limite:</span
                                            >
                                            {{
                                                foro?.dtForoFin | date: 'h:mm a'
                                            }}
                                        </span>
                                    </p>
                                </div>
                            </div>

                            <div
                                class="flex gap-2 flex-wrap align-items-center mb-4"
                            >
                                <app-icon
                                    name="matMessage"
                                    color="text-primary"
                                    size="sm"
                                />
                                <h3 class="text-lg m-0">Descripción:</h3>
                                {{ foro?.cForoDescripcion | removeHTML }}
                            </div>

                            <div
                                class="bg-gray-100 p-1 border-round min-h-10rem flex gap-2 flex-column"
                            ></div>
                        </article>
                    </div>
                    <div class="col-12 md: col-4" [hidden]="iPerfilId! === 7">
                        <article class="card col-4">
                            <div class="card-body m-3">
                                <h4>Mi Nota</h4>
                                <p-divider></p-divider>
                                <p-inputGroup>
                                    <p-inputGroupAddon>
                                        Nota
                                    </p-inputGroupAddon>
                                    <input pInputText />
                                </p-inputGroup>
                                <p-divider></p-divider>
                                <p-inputGroup>
                                    <p-inputGroupAddon>
                                        Comentario Docente
                                    </p-inputGroupAddon>
                                    <textarea pInputText rows="5"></textarea>
                                </p-inputGroup>
                            </div>
                        </article>
                    </div>
                </div>
                <article class="card">
                    <h2>Recursos:</h2>
                    <app-recursos-lista [files]="FilesTareas">
                    </app-recursos-lista>
                </article>
            </div>
        </p-tabPanel>
        <!-- Ver Comentarios de los Foros -->
        <p-tabPanel>
            <ng-template pTemplate="header">
                <div class="flex align-items-center flex-column gap-2">
                    <app-icon name="matRule"></app-icon>
                    <span class="font-bold white-space-nowrap m-0">
                        Ver Foro
                    </span>
                </div>
            </ng-template>
            <form
                [formGroup]="foroFormComntAl"
                class="flex flex-column gap-3 w-full"
            >
                <div class="flex flex-column gap-4">
                    <div class="card">
                        <h2>Foro: {{ foro?.cForoTitulo }}</h2>
                    </div>
                    <div class="card">
                        <b>
                            <label class="text-lg" for="">Recursos:</label>
                        </b>
                        <app-recursos-lista [files]="FilesTareas">
                        </app-recursos-lista>
                    </div>
                    <div class="container">
                        <!-- [class]="iPerfilId !== 8 ? 'col-12' : 'col-8'"> -->

                        <div class="card grid">
                            <!-- listar comentarios -->
                            <div
                                [class]="
                                    iPerfilId === 7
                                        ? 'col-12 md:col-8'
                                        : 'col-12'
                                "
                            >
                                <p-orderList
                                    class="list"
                                    [value]="respuestasForo"
                                    header="Comentarios:"
                                >
                                    <ng-template
                                        let-respuestas
                                        of
                                        comentarios
                                        pTemplate="listItem"
                                        let-i="index"
                                    >
                                        <p-button
                                            [text]="true"
                                            severity="secondary"
                                            class="p-col-12"
                                        >
                                            <div
                                                class="perfiles-list-item text-left"
                                                tabindex="0"
                                            >
                                                <img
                                                    src="assets/demo/images/matemit/avatar.png"
                                                    [alt]="respuestas.name"
                                                    class="w-4rem min-h-9 shadow-2 flex-shrink-0 border-round"
                                                />
                                                <div
                                                    class="perfiles-list-detail"
                                                >
                                                    <div>
                                                        <div
                                                            class="perfil-name"
                                                        >
                                                            {{
                                                                respuestas.cNombreEstudiante
                                                            }}
                                                            {{
                                                                respuestas?.dtCreado
                                                            }}
                                                        </div>
                                                    </div>
                                                    <div class="">
                                                        <div
                                                            class="perfil-name"
                                                        >
                                                            Comentario:
                                                        </div>
                                                        <span
                                                            *ngIf="
                                                                !respuestas.expanded
                                                            "
                                                        >
                                                            {{
                                                                respuestas?.cForoRptaRespuesta
                                                                    | slice
                                                                        : 0
                                                                        : 150
                                                            }}...
                                                        </span>
                                                        <span
                                                            *ngIf="
                                                                respuestas.expanded
                                                            "
                                                        >
                                                            {{
                                                                respuestas?.cForoRptaRespuesta
                                                                    | removeHTML
                                                            }}
                                                        </span>
                                                        <!-- <a (click)="toggleExpand(respuestas)" class="toggle-link">
                                                        {{ respuestas.expanded ? 'Leer menos' : 'Leer más' }}
                                                        </a> -->
                                                    </div>
                                                    <!-- startReply(i) -->
                                                    <button
                                                        (click)="startReply(i)"
                                                        class="reply-button"
                                                    >
                                                        Responder
                                                    </button>
                                                    <div
                                                        *ngIf="
                                                            respuestas
                                                                .respuestas
                                                                ?.length
                                                        "
                                                    >
                                                        <div
                                                            *ngFor="
                                                                let reply of respuestas.respuestas
                                                            "
                                                            class="reply"
                                                        >
                                                            <div
                                                                class="perfil-name"
                                                            >
                                                                Respuesta:
                                                                {{
                                                                    reply.cForoRptaRespuesta
                                                                }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </p-button>
                                    </ng-template>
                                </p-orderList>
                                <!-- Campo de respuesta y botón enviar -->
                                <div *ngIf="selectedCommentIndex !== null">
                                    <p-editor
                                        id="descripcion"
                                        placeholder="Escribe una Descripción "
                                        formControlName="cForoRptaRespuesta"
                                    />
                                    <div class="reply-container">
                                        <div class="button-container">
                                            <button
                                                icon="pi pi-times"
                                                class="send-button"
                                                type="button"
                                            >
                                                Cancelar
                                            </button>
                                            <button
                                                class="send-button"
                                                (click)="sendComment()"
                                            >
                                                Enviar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="comment-container">
                                    <input
                                        *ngIf="!showEditor"
                                        type="text"
                                        class="comment-input"
                                        placeholder="Escribe un comentario..."
                                        id="commentText"
                                        formControlName="cForoRptaRespuesta"
                                        (click)="toggleEditor()"
                                    />
                                    <div *ngIf="showEditor">
                                        <p-editor
                                            id="descripcion"
                                            placeholder="Escribe una Descripción "
                                            formControlName="cForoRptaRespuesta"
                                        />
                                        <div class="reply-container">
                                            <div class="button-container">
                                                <button
                                                    pButton
                                                    pRipple
                                                    label="Cancelar"
                                                    icon="pi pi-times"
                                                    class="p-button-secondary mx-3"
                                                    type="button"
                                                    size="small"
                                                    (click)="closeEditor()"
                                                ></button>
                                                <button
                                                    pButton
                                                    pRipple
                                                    type="button"
                                                    label="Enviar"
                                                    icon="pi pi-send"
                                                    size="small"
                                                    class="p-button-primary"
                                                    (click)="sendComment()"
                                                ></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- lista de participantes... -->
                            <div
                                class="col-12 md:col-4"
                                [hidden]="iPerfilId !== 7"
                            >
                                <p-orderList
                                    class="list"
                                    [value]="respuestasForo"
                                    header="Parcipantes:"
                                >
                                    <ng-template
                                        let-respuestas
                                        of
                                        comentarios
                                        pTemplate="listItem"
                                        let-i="index"
                                    >
                                        <div
                                            class="perfiles-list-item text-left"
                                            tabindex="0"
                                        >
                                            <img
                                                src="assets/demo/images/matemit/perfil.png"
                                                [alt]="respuestas.name"
                                                class="w-3rem"
                                            />
                                            <!--class="w-4rem min-h-9 shadow-2 flex-shrink-0 border-round"-->
                                            <div class="perfil-name">
                                                {{
                                                    respuestas.cNombreEstudiante
                                                }}
                                            </div>
                                        </div>
                                    </ng-template>
                                </p-orderList>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </p-tabPanel>
        <!-- Calificar Foro -->
        @if (iPerfilId !== 8) {
            <p-tabPanel>
                <ng-template pTemplate="header">
                    <div class="flex align-items-center flex-column gap-2">
                        <app-icon name="matRule"></app-icon>
                        <span class="font-bold white-space-nowrap m-0">
                            Calificar Foro
                        </span>
                    </div>
                </ng-template>
                <form
                    [formGroup]="foroFormComnt"
                    class="flex flex-column gap-3 w-full"
                >
                    <div class="card">
                        <h2>Foro: {{ foro?.cForoTitulo }}</h2>
                        <hr />
                        <div
                            class="flex gap-2 flex-wrap align-items-center mb-4"
                        >
                            <app-icon
                                name="matMessage"
                                color="text-primary"
                                size="sm"
                            />
                            <h3 class="text-lg m-0">Descripción:</h3>

                            {{ foro?.cForoDescripcion ?? '' | removeHTML }}
                        </div>
                    </div>
                    <!-- Mostrar las leyendas -->
                    <!-- <div class="flex gap-4 align-items-center flex-wrap mx-auto">
                        <app-leyenda
                            [total]="2"
                            text="Revisados"
                            [size]="'md'"
                            colorClass="bg-green-500"
                        ></app-leyenda>
                        <app-leyenda
                            [total]="3"
                            text="En proceso"
                            [size]="'md'"
                            colorClass="bg-yellow-500"
                        ></app-leyenda>
                        <app-leyenda
                            [total]="10"
                            text="Pendientes"
                            [size]="'md'"
                            colorClass="bg-red-500"
                        ></app-leyenda>
                    </div> -->
                    <!-- [(selection)]="evaluacionSeleccionada" (onRowSelect)="seleccionarEvaluacion()" -->
                    <!-- <div
                        class="flex flex-column gap-4 md:flex-row md:align-items-start align-items-stretch"
                    > 
                    <div class="flex flex-column gap-2 card">
                        <div class="flex gap-4 align-items-center flex-wrap mx-auto">
                            <app-leyenda
                                [total]="2"
                                text="Revisados"
                                [size]="'md'"
                                colorClass="bg-green-500"
                            ></app-leyenda>
                            <app-leyenda
                                [total]="3"
                                text="En proceso"
                                [size]="'md'"
                                colorClass="bg-yellow-500"
                            ></app-leyenda>
                            <app-leyenda
                                [total]="10"
                                text="Pendientes"
                                [size]="'md'"
                                colorClass="bg-red-500"
                            ></app-leyenda>
                        </div>
                        <div class="w-full">
                            <p-iconField iconPosition="left" class="w-full">
                                <p-inputIcon styleClass="pi pi-search" />
                                <input
                                    type="text"
                                    pInputText
                                    placeholder="Search"
                                    class="w-full"
                                />
                            </p-iconField>
                        </div>
                        <p-table
                            [value]="respuestasForo"
                            selectionMode="single"
                        >
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>#</th>
                                    <th>Nombre y Apellidos</th>
                                    <th>Estado</th>
                                    <th>Notal Final</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-respuestas
                                let-rowIndex = "rowIndex"
                                >
                                <tr>
                                    <td>
                                        {{rowIndex + 1}}
                                    </td>
                                    <td style="max-width: 150px; word-wrap: break-word;" >
                                        {{respuestas?.cNombreEstudiante}}
                                    </td>
                                    <td>
                                        <span
                                            class="block w-1rem h-1rem bg-red-500 border-circle"
                                        ></span>
                                    </td>
                                    <td></td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                    </div> -->
                    <!-- Mostrar tabla -->
                    <p-table
                        #dv
                        class="col-12 hoverTable"
                        [value]="estudiantes"
                        paginator="false"
                        styleClass="p-datatable-sm"
                    >
                        <ng-template pTemplate="header">
                            <tr>
                                <!-- incio -->
                                <p-table
                                    [value]="respuestasForo"
                                    [scrollable]="true"
                                    scrollHeight="500px"
                                >
                                    <ng-template pTemplate="header">
                                        <tr class="sticky-header">
                                            <th>#</th>
                                            <th>Nombre Estudiante</th>
                                            <th>Respuesta</th>
                                            <th>Calificación</th>
                                            <th>Descripción</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </ng-template>
                                    <ng-template
                                        pTemplate="body"
                                        let-respuestas
                                        let-rowIndex="rowIndex"
                                    >
                                        <tr>
                                            <td>
                                                <!-- <p-checkbox
                                                [(ngModel)]="estudiante.selected"
                                            ></p-checkbox> -->
                                                {{ rowIndex + 1 }}
                                            </td>
                                            <td class="">
                                                {{
                                                    respuestas?.cNombreEstudiante
                                                }}
                                            </td>
                                            <td class="">
                                                {{
                                                    respuestas?.cForoRptaRespuesta
                                                }}
                                            </td>
                                            <td>
                                                {{
                                                    respuestas?.cEscalaCalifNombre
                                                }}
                                            </td>
                                            <td>
                                                {{
                                                    respuestas?.cForoRptaDocente ??
                                                        '' | removeHTML
                                                }}
                                            </td>
                                            <td style="text-align: center">
                                                <p-button
                                                    (click)="
                                                        openModal(respuestas)
                                                    "
                                                    class="btCalificacion"
                                                    icon="pi pi-book"
                                                    rounded="true"
                                                    severity="secondary"
                                                    [style]="{
                                                        'margin-right': '.5em',
                                                    }"
                                                />

                                                <!-- <div
                                                class="w-1rem h-1rem border-circle ml-3"
                                                [ngClass]="
                                                    estudiante.cEstado === 'F'
                                                        ? 'bg-red-500'
                                                        : estudiante.cEstado === 'P'
                                                            ? 'bg-yellow-500'
                                                            : 'bg-green-500'
                                                "
                                            ></div> -->
                                            </td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                                <!-- incio -->
                            </tr></ng-template
                        >
                        <ng-template pTemplate="emptymessage" let-columns>
                            <tr>
                                <td [attr.colspan]="8">
                                    No se encontraron resultados.
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </form>
            </p-tabPanel>
        }
    </p-tabView>
</section>

<p-dialog
    [(visible)]="modalCalificacion"
    [style]="{ width: '1000px' }"
    header="Calificar las Respuestas de: {{
        estudianteSelect?.cNombreEstudiante
    }}"
    [modal]="true"
    class="p-fluid"
>
    <form [formGroup]="foroFormComnt" class="flex flex-column gap-3 w-full">
        <div class="grid">
            <!-- <div class="col-12">
                <p-messages
                    [(value)]="semana"
                    [enableService]="false"
                    [closable]="false"
                />
            </div> -->
            <!-- Mostrar el título -->
            <div class="col-8 flex flex-column gap-2">
                <!-- <app-common-input
                    [controlKey]="'cForoRptaRespuesta'"
                    label="Comentario"
                /> -->
                comentario: "{{ estudianteSelect?.cForoRptaRespuesta }}"
            </div>
            <div class="col-4 flex flex-column gap-2">
                <label for="calificacion">Calificación</label>
                <p-dropdown
                    [options]="calificacion"
                    formControlName="iEscalaCalifId"
                    styleClass="w-full"
                    optionValue="iEscalaCalifId"
                    optionLabel="cEscalaCalifNombre"
                    placeholder="Seleccione una Calificación"
                />
            </div>
            <!-- Mostrar descripción -->
            <div class="col-12">
                <label for="descripcion" class="mt-1"
                    >Descripción
                    <span class="text-red-500 text-xs"
                        >(*) Obligatorio</span
                    ></label
                >
                <div class="mt-2">
                    <p-editor
                        id="descripcion"
                        formControlName="cForoRptaDocente"
                        [style]="{ height: '150px' }"
                    />
                </div>
            </div>
        </div>
    </form>

    <div class="flex justify-content-end gap-2 pt-3">
        <button
            pButton
            pRipple
            label="Cancelar"
            icon="pi pi-times"
            class="p-button-secondary"
            type="button"
            size="small"
        ></button>
        <!-- (click)="closeModal(null)" -->
        <button
            pButton
            pRipple
            label="Guardar"
            icon="pi pi-check"
            size="small"
            class="p-button-primary"
            (click)="submit()"
        ></button>
    </div>
</p-dialog>
