<p-breadcrumb class="max-w-full" [model]="breadCrumbItems" [home]="breadCrumbHome" />

<p-panel>
  <ng-template pTemplate="header">
    <span class="text-2xl text-uppercase">
      <div class="flex flex-column">
        <div class="flex text-xl">RESUMEN DE ENCUESTA</div>
        <div class="flex text-sm">{{ cEncuNombre }}</div>
      </div>
    </span>
  </ng-template>

  <div style="position: relative; display: block">
    <div class="grid mb-3">
      <div class="col-12">
        <p-button
          #overlayAnchor
          (click)="filtros.toggle($event)"
          icon="pi pi-filter"
          class="flex"
          severity="success"
          [label]="'Ver filtros aplicados (' + filtros_aplicados + ')'"
        />
        <p-overlayPanel
          #filtros
          [appendTo]="overlayAnchorRef?.nativeElement"
          [dismissable]="false"
          [showCloseIcon]="true"
          [style]="{ width: '100%', maxWidth: '600px' }"
        >
          <ng-template pTemplate="content">
            <form [formGroup]="formFiltros" class="p-fluid">
              <div class="grid">
                <div class="col-12 md:col-6">
                  <p-inputGroup>
                    <p-inputGroupAddon>Nivel</p-inputGroupAddon>
                    <p-dropdown
                      [options]="nivel_tipos"
                      [showClear]="es_especialista"
                      formControlName="iNivelTipoId"
                      placeholder="Seleccione un nivel"
                      styleClass="group-element"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12 md:col-6">
                  <p-inputGroup>
                    <p-inputGroupAddon>Grado</p-inputGroupAddon>
                    <p-dropdown
                      [options]="nivel_grados"
                      showClear="true"
                      formControlName="iNivelGradoId"
                      placeholder="Seleccione un grado"
                      styleClass="group-element"
                      filter="true"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12 md:col-6" *ngIf="es_especialista">
                  <p-inputGroup>
                    <p-inputGroupAddon>Gestión</p-inputGroupAddon>
                    <p-dropdown
                      [options]="tipo_sectores"
                      showClear="true"
                      formControlName="iTipoSectorId"
                      placeholder="Seleccione un tipo de gestión"
                      styleClass="group-element"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12 md:col-6" *ngIf="es_especialista">
                  <p-inputGroup>
                    <p-inputGroupAddon>Zona</p-inputGroupAddon>
                    <p-dropdown
                      [options]="zonas"
                      showClear="true"
                      formControlName="iZonaId"
                      placeholder="Seleccione un tipo de zona"
                      styleClass="group-element"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12 md:col-6" *ngIf="es_especialista">
                  <p-inputGroup>
                    <p-inputGroupAddon>UGEL</p-inputGroupAddon>
                    <p-dropdown
                      [options]="ugeles"
                      [showClear]="!es_especialista_ugel"
                      formControlName="iUgelId"
                      placeholder="Seleccione una UGEL"
                      styleClass="group-element"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12 md:col-6" *ngIf="es_especialista">
                  <p-inputGroup>
                    <p-inputGroupAddon>Distrito</p-inputGroupAddon>
                    <p-dropdown
                      [options]="distritos"
                      showClear="true"
                      formControlName="iDsttId"
                      placeholder="Seleccione un distrito"
                      styleClass="group-element"
                      filter="true"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12">
                  <p-inputGroup>
                    <p-inputGroupAddon>I. E.</p-inputGroupAddon>
                    <p-dropdown
                      [options]="ies"
                      [showClear]="es_especialista"
                      formControlName="iIieeId"
                      placeholder="Seleccione una Institución Educativa"
                      styleClass="group-element"
                      filter="true"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12 md:col-6">
                  <p-inputGroup>
                    <p-inputGroupAddon>Sección</p-inputGroupAddon>
                    <p-dropdown
                      [options]="secciones"
                      showClear="true"
                      formControlName="iSeccionId"
                      placeholder="Seleccione una sección"
                      styleClass="group-element"
                      filter="true"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12 md:col-6">
                  <p-inputGroup>
                    <p-inputGroupAddon>Género</p-inputGroupAddon>
                    <p-dropdown
                      [options]="sexos"
                      showClear="true"
                      formControlName="cPersSexo"
                      placeholder="Seleccione un sexo"
                      styleClass="group-element"
                      [style]="{ flex: '1', width: '100%' }"
                    ></p-dropdown>
                  </p-inputGroup>
                </div>
                <div class="col-12">
                  <div class="flex flex-wrap gap-2">
                    <p-button
                      label="Aplicar"
                      severity="success"
                      (click)="verResumen()"
                      class="flex"
                    />
                    <p-button
                      label="Descargar gráficos"
                      icon="pi pi-download"
                      class="p-button-warning"
                      class="flex"
                      (onClick)="descargarReporte()"
                    />
                  </div>
                </div>
              </div>
            </form>
          </ng-template>
        </p-overlayPanel>
      </div>
    </div>
  </div>

  <form>
    <div class="grid">
      <div class="col-12" *ngFor="let pregunta of preguntas; let i = index">
        <p-fieldset
          [legend]="pregunta.iEncuPregOrden + '. ' + pregunta.cEncuPregContenido"
          [toggleable]="true"
          [collapsed]="false"
          [style]="{ width: '100%' }"
        >
          <ng-container *ngIf="pregunta.resumen">
            <div class="grid text-panel" [formGroup]="getFormResumenPregunta(i)">
              <div class="col-12 md:col-6" *ngIf="+pregunta.iEncuPregTipoId !== PREGUNTA_ABIERTA">
                <p-inputGroup>
                  <p-inputGroupAddon>Tipo de gráfico</p-inputGroupAddon>
                  <p-dropdown
                    [options]="tipos_graficos"
                    formControlName="iTipoGrafico"
                    [filter]="true"
                    [showClear]="false"
                    appendTo="body"
                    placeholder="Seleccione"
                    [style]="{ flex: '1', width: '100%' }"
                    styleClass="group-element"
                  />
                </p-inputGroup>
              </div>
              <div class="col-12 md:col-6" *ngIf="+pregunta.iEncuPregTipoId === PREGUNTA_ABIERTA">
                <p-inputGroup>
                  <p-inputGroupAddon>Tipo de reporte</p-inputGroupAddon>
                  <p-dropdown
                    [options]="tipos_reportes"
                    formControlName="iTipoReporte"
                    [filter]="true"
                    [showClear]="false"
                    appendTo="body"
                    placeholder="Seleccione"
                    [style]="{ flex: '1', width: '100%' }"
                    styleClass="group-element"
                  />
                </p-inputGroup>
              </div>
              <div class="col-12" *ngIf="+pregunta.iEncuPregTipoId !== PREGUNTA_ABIERTA">
                <p-chart
                  *ngIf="getFormResumenPregunta(i).get('iTipoGrafico')?.value === GRAFICO_BARRA"
                  type="bar"
                  [data]="pregunta.resumen_grafico"
                  [options]="options_bar"
                  [plugins]="plugin_bar"
                  style="width: 100%"
                />
                <p-chart
                  *ngIf="getFormResumenPregunta(i).get('iTipoGrafico')?.value === GRAFICO_CIRCULAR"
                  type="pie"
                  [data]="pregunta.resumen_grafico"
                  [options]="options_pie"
                  [plugins]="plugin_pie"
                  class="col-12 md:col-6"
                  height="300px"
                />
              </div>
              <div class="col-12" *ngIf="+pregunta.iEncuPregTipoId === PREGUNTA_ABIERTA">
                <p-chart
                  *ngIf="
                    getFormResumenPregunta(i).get('iTipoReporte')?.value === TIPO_REPORTE_LISTA
                  "
                  type="bar"
                  [data]="pregunta.resumen_grafico"
                  [options]="options_bar"
                  [plugins]="plugin_bar"
                  style="width: 100%"
                />
                <app-wordcloud-chart
                  *ngIf="
                    getFormResumenPregunta(i).get('iTipoReporte')?.value === TIPO_REPORTE_INDIVIDUAL
                  "
                  [wordCloudData]="pregunta.resumen_wordcloud"
                  [WordCloudOptions]="options_wordcloud"
                />
              </div>
            </div>
          </ng-container>
        </p-fieldset>
      </div>
    </div>
  </form>
</p-panel>
