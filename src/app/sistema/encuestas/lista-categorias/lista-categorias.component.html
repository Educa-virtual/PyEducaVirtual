<p-breadcrumb class="max-w-full" [model]="breadCrumbItems" [home]="breadCrumbHome" />

<p-panel>
  <ng-template pTemplate="header">
    <span class="text-2xl text-uppercase">Categorías de encuestas</span>
  </ng-template>
  <ng-template pTemplate="icons" class="flex justify-content-center" *ngIf="puede_crear">
    <p-button label="Nueva" icon="pi pi-plus" severity="success" (click)="agregarCategoria()" />
  </ng-template>

  <div class="grid">
    <div class="col-12">
      <p-inputGroup>
        <p-inputGroupAddon> Buscar </p-inputGroupAddon>
        <input #filtro type="text" pInputText (input)="filtrarTabla()" />
      </p-inputGroup>
    </div>
  </div>

  @if (!categorias_filtradas || categorias_filtradas.length === 0) {
    <app-no-data [showIcon]="'NO-DATA'" mensaje="No hay categorías disponibles" />
  } @else {
    <p-dataView [rows]="10" [paginator]="true" [value]="categorias_filtradas">
      <ng-template pTemplate="list" let-categorias_filtradas>
        <div class="categorias-grid">
          <div *ngFor="let categoria of categorias_filtradas" class="categoria-item">
            <article
              class="card p-0 border-1 flex flex-column surface-border h-full post-module border-round"
            >
              <div class="image-container img-transition border-round-top overflow-hidden">
                <img
                  [alt]="categoria?.cCateNombre"
                  class="w-full h-full"
                  [src]="rutaImagenPlaceholder(categoria)"
                />
              </div>
              <div class="p-3 mb-auto">
                <h3 class="text-xl p-0 m-0">
                  <i
                    *ngIf="+categoria?.bEsFija"
                    class="pi pi-fw pi-lock"
                    (click)="panel.toggle($event)"
                    (keypress)="panel.toggle($event)"
                    pTooltip="Categoría fija: Tiene una cantidad fija de encuestas, no puede modificar la población objetivo y accesos predeterminados"
                    tooltipPosition="top"
                    tabindex="0"
                  >
                  </i>
                  <i *ngIf="+categoria?.bEsEnlace" class="pi pi-fw pi-link"></i>
                  {{ categoria?.cCateNombre | uppercase }}
                </h3>
              </div>
              <p-overlayPanel #panel [showCloseIcon]="true" appendTo="body">
                <div class="flex w-15rem">
                  Categoría fija: Tiene una cantidad fija de encuestas, no puede modificar la
                  población objetivo y accesos predeterminados
                </div>
              </p-overlayPanel>
              <footer class="p-3 pt-0 flex align-items-center justify-content-between">
                <a [routerLink]="" (click)="gestionarEncuestas(categoria?.iCateId)">
                  <span *ngIf="+categoria?.iCantBorradores > 0">
                    {{ +categoria?.iCantBorradores }}
                    {{ +categoria?.iCantBorradores === 1 ? 'borrador' : 'borradores' }}
                  </span>
                </a>
                <span *ngIf="+categoria?.iCantBorradores === 0"></span>
                <div class="flex gap-1">
                  @if (categoria?.btnItems.length > 0) {
                    <p-splitButton
                      severity="primary"
                      size="small"
                      [model]="categoria?.btnItems"
                      badge="100"
                      (onClick)="listarEncuestas(categoria?.iCateId)"
                      [menuStyle]="{ 'z-index': '1000' }"
                    >
                      <ng-template pTemplate="content">
                        {{ +categoria?.iCantSinResponder === 0 ? 'Acceder' : 'Responder' }}
                        <p-badge
                          *ngIf="+categoria?.iCantSinResponder > 0"
                          [value]="categoria?.iCantSinResponder"
                          severity="danger"
                        />
                      </ng-template>
                    </p-splitButton>
                  } @else {
                    <p-button
                      size="small"
                      severity="primary"
                      (onClick)="listarEncuestas(categoria?.iCateId)"
                    >
                      {{ +categoria?.iCantSinResponder === 0 ? 'Acceder' : 'Responder' }}
                      <p-badge
                        *ngIf="+categoria?.iCantSinResponder > 0"
                        [value]="categoria?.iCantSinResponder"
                        severity="danger"
                      />
                    </p-button>
                  }
                </div>
              </footer>
            </article>
          </div>
        </div>
      </ng-template>
    </p-dataView>
  }
</p-panel>

<app-nueva-categoria
  [(visible)]="visibleDialogCategoria"
  (categoriaModificada)="listarCategorias()"
  [iCateId]="iCateId"
></app-nueva-categoria>

<p-toast></p-toast>
