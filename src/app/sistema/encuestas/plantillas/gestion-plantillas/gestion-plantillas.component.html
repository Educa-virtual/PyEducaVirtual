<p-breadcrumb class="max-w-full" [model]="breadCrumbItems" [home]="breadCrumbHome" />

<p-panel>
  <ng-template pTemplate="header">
    <div class="flex flex-column">
      <div class="flex text-xl">GESTIONAR PLANTILLAS DE CATEGORÍA</div>
      <div class="flex text-sm">{{ categoria?.cCateNombre }}</div>
    </div>
  </ng-template>
  <ng-template pTemplate="icons" class="flex justify-content-center">
    <div class="flex gap-2">
      <p-button
        severity="success"
        pTooltip="Nueva"
        tooltipPosition="top"
        (click)="agregarPlantilla()"
      >
        <i class="pi pi-fw pi-plus"></i>
        <span class="hidden md:inline ml-2">Nueva</span>
      </p-button>
      <p-button
        labelTooltip="Tutorial"
        tooltipPosition="top"
        severity="secondary"
        (click)="verTutorial(true)"
      >
        <i class="pi pi-question-circle"></i>
        <span class="hidden md:inline ml-2">Tutorial</span>
      </p-button>
    </div>
  </ng-template>

  <div class="grid">
    <div class="col-12">
      <form [formGroup]="formPlantillas">
        <div class="grid p-fluid">
          <div class="col-12 md:col align-content-center">
            <p-inputGroup>
              <p-inputGroupAddon> Estado </p-inputGroupAddon>
              <p-dropdown
                #tipo_reporte
                [options]="tipos_reportes_plantillas"
                formControlName="iTipoReporte"
                [showClear]="false"
                appendTo="body"
                placeholder="Seleccione"
                styleClass="group-element"
                appendTo="body"
                (onChange)="listarPlantillas()"
              />
            </p-inputGroup>
          </div>
          <div class="col">
            <p-inputGroup>
              <p-inputGroupAddon> Buscar </p-inputGroupAddon>
              <input #filtro type="text" pInputText (input)="filtrarPlantillas()" />
            </p-inputGroup>
          </div>
          <div class="col-auto align-content-center">
            <p-button
              severity="info"
              pTooltip="Ver Encuestas"
              tooltipPosition="top"
              arial-label="Ver Encuestas"
              (onClick)="listarEncuestas()"
            >
              <i class="pi pi-fw pi-arrow-right-arrow-left"></i>
              <span class="hidden md:inline ml-2">Encuestas</span>
            </p-button>
          </div>
        </div>
      </form>
    </div>
    <div class="col-12">
      <app-table-primeng
        [columnas]="columns_plantillas"
        [(selectedRowData)]="selectedItem"
        [showCaption]="false"
        [data]="plantillas_filtradas"
        [showPaginator]="true"
        [showSortIcon]="true"
        [actions]="actions_plantillas"
        (accionBtnItem)="accionBtnItemTable($event)"
      />
    </div>
  </div>
</p-panel>

<p-dialog
  header="Generar encuesta desde plantilla"
  [style]="{ width: '50vw' }"
  [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
  [(visible)]="visibleDialogEncuesta"
  modal="modal"
  [draggable]="false"
  [blockScroll]="true"
  [resizable]="false"
  (onHide)="resetFormEncuesta()"
>
  <br />
  <form [formGroup]="formEncuestaPlantilla">
    <div class="grid">
      <div class="col-12">
        <p-inputGroup class="vertical-group">
          <p-inputGroupAddon> Plantilla </p-inputGroupAddon>
          <input
            pInputText
            styleClass="group-element"
            formControlName="cPlanNombre"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
        </p-inputGroup>
      </div>
      <div class="col-12">
        <p-inputGroup>
          <p-inputGroupAddon> Título </p-inputGroupAddon>
          <input
            pInputText
            styleClass="group-element"
            placeholder="Ingrese título o deje en blanco para usar la plantilla"
            formControlName="cEncuNombre"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
        </p-inputGroup>
      </div>
      <div class="col-12">
        <p-inputGroup>
          <p-inputGroupAddon> Subtítulo </p-inputGroupAddon>
          <input
            pInputText
            styleClass="group-element"
            placeholder="Ingrese subtítulo o deje en blanco para usar la plantilla"
            formControlName="cEncuSubtitulo"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
        </p-inputGroup>
      </div>
      <div class="col-12 md:col-6">
        <p-inputGroup>
          <p-inputGroupAddon>Inicio *</p-inputGroupAddon>
          <p-calendar
            inputStyleClass="group-element"
            view="date"
            formControlName="dEncuInicio"
            dateFormat="dd/mm/yy"
            placeholder="Fecha de inicio"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
        </p-inputGroup>
      </div>
      <div class="col-12 md:col-6">
        <p-inputGroup>
          <p-inputGroupAddon>Cierre *</p-inputGroupAddon>
          <p-calendar
            inputStyleClass="group-element"
            view="date"
            formControlName="dEncuFin"
            dateFormat="dd/mm/yy"
            placeholder="Fecha de cierre"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
        </p-inputGroup>
      </div>
      <div class="col-12">
        <p-inputGroup>
          <p-inputGroupAddon>
            <a
              role="button"
              class="p-button p-button-secondary mr-2"
              (click)="iTiemDurId.toggle($event)"
              (keypress)="iTiemDurId.toggle($event)"
              tabindex="0"
            >
              <i class="pi pi-question-circle"></i>
            </a>
            <span>Tiempo edición *</span>
          </p-inputGroupAddon>
          <p-dropdown
            styleClass="group-element"
            [options]="tiempos_duracion"
            placeholder="Seleccione tiempo"
            formControlName="iTiemDurId"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
          <p-overlayPanel #iTiemDurId showCloseIcon="true" appendTo="body">
            <div class="flex w-15rem">
              El tiempo que el encuestado tendrá para editar sus respuestas una vez que las haya
              registrado por primera vez.
            </div>
          </p-overlayPanel>
        </p-inputGroup>
      </div>
      <div class="col-12 md:col-4">
        <p-inputGroup class="vertical-group">
          <p-inputGroupAddon>
            <p-inputSwitch
              formControlName="bCopiarPoblacion"
              label="Copiar población"
            ></p-inputSwitch>
            <span>Copiar población</span>
          </p-inputGroupAddon>
        </p-inputGroup>
      </div>
      <div class="col-12 md:col-4">
        <p-inputGroup class="vertical-group">
          <p-inputGroupAddon>
            <p-inputSwitch formControlName="bCopiarAccesos" label="Copiar accesos"></p-inputSwitch>
            <span>Copiar accesos</span>
          </p-inputGroupAddon>
        </p-inputGroup>
      </div>
      <div class="col-12 md:col-4">
        <p-inputGroup class="vertical-group">
          <p-inputGroupAddon>
            <p-inputSwitch
              formControlName="bCopiarPreguntas"
              label="Copiar preguntas"
            ></p-inputSwitch>
            <span>Copiar preguntas</span>
          </p-inputGroupAddon>
        </p-inputGroup>
      </div>
    </div>
  </form>
  <div class="flex justify-content-between">
    <p-button
      label="Salir"
      severity="secondary"
      icon="pi pi-arrow-left"
      iconPos="left"
      (onClick)="cerrarDialogGenerarEncuesta()"
    />
    <p-button
      label="Generar"
      severity="success"
      icon="pi pi-save"
      iconPos="left"
      (onClick)="generarEncuesta()"
    />
  </div>
</p-dialog>

<p-dialog
  header="Duplicar plantilla"
  [style]="{ width: '50vw' }"
  [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
  [(visible)]="visibleDialogDuplicar"
  modal="modal"
  [draggable]="false"
  [blockScroll]="true"
  [resizable]="false"
  (onHide)="resetFormPlantilla()"
>
  <br />
  <form [formGroup]="formPlantilla">
    <div class="grid">
      <div class="col-12">
        <p-inputGroup class="vertical-group">
          <p-inputGroupAddon> Plantilla </p-inputGroupAddon>
          <input
            pInputText
            styleClass="group-element"
            formControlName="cPlanOriginalNombre"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
        </p-inputGroup>
      </div>
      <div class="col-12">
        <p-inputGroup>
          <p-inputGroupAddon> Título </p-inputGroupAddon>
          <input
            pInputText
            styleClass="group-element"
            placeholder="Ingrese título o deje en blanco para usar la plantilla original"
            formControlName="cPlanNombre"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
        </p-inputGroup>
      </div>
      <div class="col-12">
        <p-inputGroup>
          <p-inputGroupAddon> Subtítulo </p-inputGroupAddon>
          <input
            pInputText
            styleClass="group-element"
            placeholder="Ingrese subtítulo o deje en blanco para usar la plantilla original"
            formControlName="cPlanSubtitulo"
            appendTo="body"
            [style]="{ flex: '1', width: '100%' }"
          />
        </p-inputGroup>
      </div>
      <div class="col-12 md:col-4">
        <p-inputGroup class="vertical-group">
          <p-inputGroupAddon>
            <p-inputSwitch
              formControlName="bCopiarPoblacion"
              label="Copiar población"
            ></p-inputSwitch>
            <span>Copiar población</span>
          </p-inputGroupAddon>
        </p-inputGroup>
      </div>
      <div class="col-12 md:col-4">
        <p-inputGroup class="vertical-group">
          <p-inputGroupAddon>
            <p-inputSwitch formControlName="bCopiarAccesos" label="Copiar accesos"></p-inputSwitch>
            <span>Copiar accesos</span>
          </p-inputGroupAddon>
        </p-inputGroup>
      </div>
      <div class="col-12 md:col-4">
        <p-inputGroup class="vertical-group">
          <p-inputGroupAddon>
            <p-inputSwitch
              formControlName="bCopiarPreguntas"
              label="Copiar preguntas"
            ></p-inputSwitch>
            <span>Copiar preguntas</span>
          </p-inputGroupAddon>
        </p-inputGroup>
      </div>
    </div>
  </form>
  <div class="flex justify-content-between">
    <p-button
      label="Salir"
      severity="secondary"
      icon="pi pi-arrow-left"
      iconPos="left"
      (onClick)="cerrarDialogDuplicarPlantilla()"
    />
    <p-button
      label="Generar"
      severity="success"
      icon="pi pi-save"
      iconPos="left"
      (onClick)="duplicarPlantilla()"
    />
  </div>
</p-dialog>

<p-dialog
  header="Tutorial"
  [style]="{ width: '50vw' }"
  [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
  [(visible)]="visibleDialogTutorial"
  modal="modal"
  [draggable]="false"
  [blockScroll]="true"
  [resizable]="false"
>
  <app-tutorial-plantillas (visibleDialogTutorial)="verTutorial($event)" />
</p-dialog>

<p-dialog
  header="Generar encuestas masivas"
  [style]="{ width: '75vw' }"
  [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
  [(visible)]="visibleDialogGenerar"
  modal="modal"
  [draggable]="false"
  [blockScroll]="true"
  [resizable]="false"
  (onHide)="resetFormEncuestaFija()"
>
  <br />
  <form [formGroup]="formEncuestaFija">
    <p>
      Las encuestas se crearán para las áreas y/o periodos configurados. Si no contienen datos
      realice la configuración de áreas y periodos académicos.
    </p>
    @if (es_director) {
      <p>
        Esta acción reeemplazará, para su I.E., las encuestas existentes registradas por el
        Administrador que aún no han sido respondidas por sus estudiantes. Solo usted podrá editar
        las nuevas encuestas.
      </p>
    }
    <div class="grid">
      @if (periodos.length > 0) {
        @for (periodo of periodos; track $index) {
          <div class="col-12" *ngIf="controles_periodos && controles_periodos.length > 0">
            <p-inputGroup class="vertical-group">
              <p-inputGroupAddon>
                {{ periodo['label'] }} {{ periodo['esta_vencido'] ? '(VENCIDO)' : '' }}
              </p-inputGroupAddon>
              <p-multiSelect
                *ngIf="!periodo['esta_vencido']"
                display="chip"
                filter="true"
                [options]="periodo['cursos']"
                [formControl]="$any(controles_periodos.at($index)).controls['iCursoId']"
                showClear="true"
                appendTo="body"
                showToggleAll="true"
                [maxSelectedLabels]="undefined"
                [style]="{ flex: '1', width: '100%' }"
                styleClass="group-element text-left"
              />
            </p-inputGroup>
          </div>
        }
      } @else if (cursos.length > 0) {
        <div class="col-12">
          <p-inputGroup class="vertical-group">
            <p-inputGroupAddon> Cursos </p-inputGroupAddon>
            <p-multiSelect
              display="chip"
              filter="true"
              [options]="cursos"
              formControlName="iCursoId"
              showClear="true"
              appendTo="body"
              showToggleAll="true"
              [maxSelectedLabels]="undefined"
              [style]="{ flex: '1', width: '100%' }"
              styleClass="group-element text-left"
            />
          </p-inputGroup>
        </div>
      } @else {
        <div class="col-12">No tiene áreas ni periodos configurados.</div>
      }
    </div>

    <div class="flex justify-content-center flex-wrap gap-2">
      <p-button label="Cancelar" (click)="visibleDialogGenerar = false" severity="secondary" />
      <p-button
        label="Generar"
        (click)="generarEncuestaPlantilla(null, selectedItem)"
        severity="success"
      />
    </div>
  </form>
</p-dialog>

<p-toast></p-toast>
